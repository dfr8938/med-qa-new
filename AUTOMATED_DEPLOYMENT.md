# Автоматизированное развертывание Medical Q&A Portal

## Обзор

Этот документ описывает автоматизированный процесс развертывания Medical Q&A Portal с использованием скрипта `automated-deploy.sh`. Скрипт выполняет все шаги, описанные в основном руководстве развертывания (DEPLOYMENT.md), в автоматическом режиме.

## Требования

- Ubuntu 20.04 или выше (рекомендуется)
- Доступ к root или sudo
- Доступ в интернет для загрузки зависимостей
- Доменное имя (опционально, для SSL)

## Использование

### Базовое развертывание

```bash
sudo ./automated-deploy.sh
```

### Развертывание с параметрами

```bash
# Развертывание с указанием домена и IP-адреса
sudo ./automated-deploy.sh -d medsester.ru -i 130.49.149.185

# Развертывание с SSL сертификатом
sudo ./automated-deploy.sh -d medsester.ru -i 130.49.149.185 --ssl

# Полная очистка и новое развертывание
sudo ./automated-deploy.sh -r -d medsester.ru -i 130.49.149.185 --ssl
```

### Параметры командной строки

- `-d, --domain DOMAIN` - Доменное имя для настройки SSL
- `-i, --ip IP_ADDRESS` - IP-адрес сервера
- `-s, --ssl` - Включить настройку SSL сертификата
- `-r, --reset` - Сбросить существующую установку
- `-h, --help` - Показать справку

## Что делает скрипт

1. **Проверяет системные требования**:
   - Проверяет версию Ubuntu
   - Проверяет наличие необходимых пакетов

2. **Обновляет систему**:
   - Выполняет `apt update && apt upgrade -y`

3. **Устанавливает необходимые пакеты**:
   - Node.js 16.x
   - PostgreSQL
   - Nginx
   - Git, curl, bc, certbot

4. **Настраивает базу данных**:
   - Создает базы данных для production, development и test
   - Создает пользователя базы данных `med_qa_user`
   - Назначает все необходимые привилегии
   - Настраивает схему public

5. **Развертывает приложение**:
   - Клонирует репозиторий из GitHub
   - Устанавливает зависимости сервера и клиента
   - Создает production сборку клиента

6. **Настраивает переменные окружения**:
   - Создает файлы `.env.production`, `.env.development`, `.env.test`
   - Генерирует уникальные секреты для JWT

7. **Выполняет миграции и сиды**:
   - Устанавливает sequelize-cli
   - Выполняет миграции базы данных
   - Загружает начальные данные

8. **Настраивает systemd сервис**:
   - Создает и включает сервис `med-qa.service`
   - Настраивает переменные окружения (HOST, DOMAIN)

9. **Настраивает Nginx**:
   - Создает конфигурацию сайта
   - Добавляет IP-адрес в server_name
   - Настраивает проксирование к API

10. **Настраивает SSL (если включено)**:
    - Получает SSL сертификат через Let's Encrypt
    - Настраивает автоматическое обновление

11. **Запускает приложение**:
    - Перезапускает systemd сервис
    - Проверяет статус работы

## Конфигурационные файлы

### Сервис systemd

Файл: `/etc/systemd/system/med-qa.service`

Содержит настройки окружения:
- `NODE_ENV=production`
- `HOST=130.49.149.185`
- `DOMAIN=medsester.ru`

### Конфигурация Nginx

Файл: `/etc/nginx/sites-available/med-qa`

Включает:
- server_name с доменом и IP-адресом
- Статическую раздачу файлов
- Проксирование API запросов на порт 5000

### Переменные окружения

Файлы:
- `/opt/med-qa-portal/server/.env.production`
- `/opt/med-qa-portal/server/.env.development`
- `/opt/med-qa-portal/server/.env.test`

Содержат:
- Уникальные JWT секреты
- Настройки подключения к базе данных
- Уровни логирования

## Устранение неполадок

### Проверка статуса сервиса

```bash
systemctl status med-qa.service
```

### Просмотр логов

```bash
# Логи systemd сервиса
journalctl -u med-qa.service -f

# Логи развертывания
tail -f /var/log/med-qa-deploy.log
```

### Перезапуск сервиса

```bash
systemctl restart med-qa.service
```

### Проверка конфигурации Nginx

```bash
nginx -t
systemctl reload nginx
```

## Обновление приложения

Для обновления приложения до последней версии из репозитория:

```bash
cd /opt/med-qa-portal
git pull origin main
cd client && npm install && npm run build
cd ../server && npm install
systemctl restart med-qa.service
```

## Структура проекта после развертывания

```
/opt/med-qa-portal/
├── client/
│   ├── dist/           # Production сборка
│   ├── node_modules/
│   ├── src/
│   └── package.json
├── server/
│   ├── .env.*          # Файлы окружения
│   ├── node_modules/
│   ├── public/          # Статические файлы
│   ├── src/
│   └── package.json
└── deployment/         # Файлы развертывания
```

## Безопасность

- Все пароли генерируются автоматически
- JWT секреты уникальны для каждой установки
- База данных защищена надежными паролями
- API защищен CORS и cookie-аутентификацией

## Резервное копирование

Рекомендуется регулярно создавать резервные копии:

1. Базы данных PostgreSQL
2. Файлов конфигурации
3. Сгенерированных SSL сертификатов

## Поддержка

При возникновении проблем с автоматическим развертыванием:
1. Проверьте логи: `/var/log/med-qa-deploy.log`
2. Убедитесь, что все требования выполнены
3. Попробуйте выполнить развертывание вручную по инструкции DEPLOYMENT.md